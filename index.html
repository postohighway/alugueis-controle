<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Alugu√©is & DRE Consolidado</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    *{box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text",Arial,sans-serif}
    body{margin:0;padding:12px;background:#f2f2f7;font-size:16px}
    h1{font-size:22px;text-align:center;margin:0 0 10px}
    h2{font-size:18px;margin:18px 0 8px}
    label{display:block;font-size:14px;margin-top:6px}
    input,select,button,textarea{width:100%;padding:6px 8px;margin-top:3px;border-radius:8px;border:1px solid #d1d1d6;font-size:15px}
    input:focus,textarea:focus,button:focus{outline:none;border-color:#007aff;box-shadow:0 0 0 1px rgba(0,122,255,.3)}
    button{background:#007aff;color:#fff;border:none;font-weight:600;margin-top:10px;cursor:pointer}
    button.secondary{background:#fff;color:#007aff;border:1px solid #007aff}
    .top-bar-main{background:#fff;padding:10px 12px;border-radius:10px;box-shadow:0 2px 4px rgba(0,0,0,.05);margin-bottom:10px}
    .tabs-header{display:flex;gap:8px;margin-bottom:10px}
    .tab-button{flex:1;padding:8px;border-radius:999px;border:1px solid #d1d1d6;background:#fff;color:#333;font-weight:600;font-size:14px}
    .tab-button.active{background:#007aff;color:#fff;border-color:#007aff}
    .tab-content{display:none}.tab-content.active{display:block}
    .cards-container{margin-top:10px}
    .card{background:#fff;border-radius:12px;padding:10px 12px;margin-bottom:10px;box-shadow:0 2px 4px rgba(0,0,0,.05)}
    .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    .card-title{font-weight:700;font-size:16px}
    .status-tag{font-size:12px;padding:2px 6px;border-radius:8px;color:#fff}
    .status-aberto{background:#ff3b30}.status-parcial{background:#ff9f0a}.status-pago{background:#34c759}
    .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-top:4px}
    .grid-2{display:grid;grid-template-columns:repeat(2,1fr);gap:6px;margin-top:4px}
    .small-label{font-size:12px;color:#8e8e93}
    .small-value{font-weight:600;font-size:14px}
    .payments{margin-top:8px;border-top:1px solid #e5e5ea;padding-top:6px}
    .payments-list{max-height:140px;overflow-y:auto;margin-top:4px;border-radius:8px;border:1px solid #e5e5ea;padding:4px 6px;background:#fafafa;font-size:13px}
    .payment-row{display:flex;justify-content:space-between;gap:4px;padding:2px 0;border-bottom:1px dashed #e5e5ea}
    .payment-row:last-child{border-bottom:none}
    .payment-note{color:#8e8e93;font-size:12px}
    .summary-box{background:#fff;border-radius:12px;padding:10px 12px;margin-top:10px;box-shadow:0 2px 4px rgba(0,0,0,.05)}
    .summary-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-top:6px}
    .summary-item-label{font-size:13px;color:#8e8e93}
    .summary-item-value{font-size:15px;font-weight:600}
    .whatsapp-hint{font-size:12px;color:#8e8e93;margin-top:4px}
    .summary-table-wrapper{overflow-x:auto;margin-top:6px}
    table.summary-table{width:100%;border-collapse:collapse;font-size:13px}
    table.summary-table thead{background:#f2f2f7}
    table.summary-table th,table.summary-table td{padding:4px 6px;border-bottom:1px solid #e5e5ea;text-align:right;white-space:nowrap}
    table.summary-table th:first-child,table.summary-table td:first-child{text-align:left}
    table.summary-table tr:last-child td{border-bottom:none}
    .acet-sub{font-size:12px;text-align:center;color:#666;margin-bottom:8px}
    .acet-top-bar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .acet-top-bar>div{flex:1;min-width:120px}
    .acet-actions-top{display:flex;gap:6px;margin-top:6px;flex-wrap:wrap}
    .btn-small{font-size:11px;padding:5px 8px;border-radius:20px}
    .btn-outline{background:transparent;border:1px solid #d1d1d6;color:#666}
    .btn-danger{background:#ff3b30;color:#fff;font-size:12px;padding:4px 6px;border:none;border-radius:10px;cursor:pointer}
    .acet-scroll-table{max-height:320px;overflow-y:auto;background:#fff;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,.1)}
    .acet-debit-row{background-color:#ffecec}
    .acet-credit-row{background-color:#e9ffea}
    .acet-totais{font-size:13px;margin-top:5px}
    .saldo-positivo{color:#ff3b30;font-weight:600}
    .saldo-negativo{color:#30d158;font-weight:600}
    .acet-pill{font-size:11px;padding:3px 6px;border-radius:999px;border:1px solid #d1d1d6;color:#666;display:inline-block;margin-top:2px}
    .acet-resumo-box{font-size:12px;line-height:1.4;white-space:pre-line}
    @media(min-width:768px){body{max-width:900px;margin:0 auto}}
    @media print{.tabs-header,#tab-acerto,#tab-receitas{display:none!important}}
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <h1>Alugu√©is & DRE Consolidado</h1>

  <div class="tabs-header">
    <button class="tab-button active" id="btnTabAlugueis" onclick="showTab('alugueis')">Alugu√©is + Energia</button>
    <button class="tab-button" id="btnTabAcerto" onclick="showTab('acerto')">Acerto Juliano (Lava R√°pido)</button>
    <button class="tab-button" id="btnTabReceitas" onclick="showTab('receitas')">Receitas em Dinheiro</button>
    <button class="tab-button" id="btnTabDR" onclick="showTab('dr')">DRE</button>
  </div>

  <div id="tab-alugueis" class="tab-content active">
    <div class="top-bar-main">
      <label for="valorKwh">Valor do kWh (Cemig) ‚Äì R$</label>
      <input type="number" id="valorKwh" step="0.0001" inputmode="decimal" placeholder="Ex: 0.95" />
      <label for="mesRef">M√™s de refer√™ncia (YYYY-MM)</label>
      <input type="month" id="mesRef" />
      <button id="btnCarregarMes">Carregar m√™s</button>
      <small class="whatsapp-hint">Regras: Lava R√°pido = ACERTO (n√£o entra como receita). Loja de Conveni√™ncia = j√° est√° no DRE cont√°bil (n√£o entra no ajuste do DRE).</small>
    </div>

    <div class="cards-container" id="cardsContainer"></div>

    <div class="summary-box" id="summaryBox" style="display:none;">
      <h2>Resumo geral do m√™s (ajuste do DRE)</h2>
      <div class="summary-grid">
        <div><div class="summary-item-label">Total de alugu√©is (receita extra)</div><div class="summary-item-value" id="sumAlugueis">R$ 0,00</div></div>
        <div><div class="summary-item-label">Total energia l√≠quida (receita extra)</div><div class="summary-item-value" id="sumEnergia">R$ 0,00</div></div>
        <div><div class="summary-item-label">Total (alugu√©is + energia) (receita extra)</div><div class="summary-item-value" id="sumTotalMes">R$ 0,00</div></div>
        <div><div class="summary-item-label">Receitas n√£o operacionais (dinheiro) ‚Äì l√≠quido</div><div class="summary-item-value" id="sumReceitasExtra">R$ 0,00</div></div>
        <div><div class="summary-item-label">Total geral (para ajuste do DRE)</div><div class="summary-item-value" id="sumTotalGeral">R$ 0,00</div></div>
      </div>
    </div>

    <div class="summary-box" id="summaryUnidadesBox" style="display:none;">
      <h2>Resumo r√°pido por unidade</h2>
      <div class="summary-table-wrapper">
        <table class="summary-table">
          <thead>
            <tr><th>Unidade</th><th>Aluguel</th><th>Energia l√≠quida</th><th>Total m√™s</th><th>Pago</th><th>Saldo</th><th>Status</th></tr>
          </thead>
          <tbody id="summaryUnidadesBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="tab-acerto" class="tab-content">
    <div class="card">
      <h2>AcetJuli</h2>
      <div class="acet-sub">D√©bito = RF pagou / Cr√©dito = Juliano pagou (controle de acerto do Lava R√°pido).</div>

      <div class="card">
        <div class="acet-top-bar">
          <div><label for="acetFilterMonth">M√™s (YYYY-MM)</label><input type="month" id="acetFilterMonth"></div>
        </div>
        <div class="acet-actions-top">
          <button class="btn-small" style="background:#007aff;color:#fff;" onclick="acetSetCurrentMonth()">Hoje</button>
          <button class="btn-small btn-outline" onclick="acetDownloadBackup()">Backup (.json)</button>
          <button class="btn-small btn-outline" onclick="acetImportData()">Importar (colar JSON)</button>
          <button class="btn-small" style="background:#555;color:#fff;" onclick="acetClearAll()">Zerar tudo</button>
        </div>
        <textarea id="acetJsonArea" style="width:100%;height:120px;display:none;margin-top:8px;" placeholder="Cole aqui o JSON do backup e clique em Importar"></textarea>
      </div>

      <div class="card">
        <h2>Novo lan√ßamento</h2>
        <span class="acet-pill">D√©bito = RF pagou ¬∑ Cr√©dito = Juliano pagou</span>
        <label for="acetDateInput">Data</label><input type="date" id="acetDateInput">
        <label for="acetDescInput">Descri√ß√£o</label><input type="text" id="acetDescInput" placeholder="Ex.: Biotri, CEMIG, DMAE...">
        <label for="acetTypeInput">Tipo</label>
        <select id="acetTypeInput">
          <option value="DEBITO_RF">D√©bito - RF pagou</option>
          <option value="CREDITO_JULIANO">Cr√©dito - Juliano pagou</option>
        </select>
        <label for="acetValueInput">Valor (R$)</label><input type="number" id="acetValueInput" step="0.01" inputmode="decimal" placeholder="0,00">
        <button onclick="acetAddTransaction()">Incluir lan√ßamento</button>
      </div>

      <div class="card">
        <h2>Lan√ßamentos do m√™s</h2>
        <div class="acet-scroll-table">
          <table style="width:100%;border-collapse:collapse;font-size:13px;">
            <thead style="background:#f2f2f7;">
              <tr><th style="text-align:left;padding:6px;">Data</th><th style="text-align:left;padding:6px;">Descri√ß√£o</th><th style="text-align:left;padding:6px;">Tipo</th><th style="text-align:right;padding:6px;">Valor</th><th style="text-align:center;padding:6px;"></th></tr>
            </thead>
            <tbody id="acetTableBody"></tbody>
          </table>
        </div>
        <div class="acet-totais" id="acetTotaisBox"></div>
      </div>

      <div class="card">
        <h2>Resumo para WhatsApp / Print</h2>
        <div id="acetWhatsResumo" class="acet-resumo-box"></div>
      </div>
    </div>
  </div>

  <div id="tab-receitas" class="tab-content">
    <div class="card">
      <h2>Receitas n√£o operacionais em dinheiro</h2>
      <div class="acet-sub">Resultado l√≠quido entra no ajuste do DRE (cr√©ditos - d√©bitos).</div>

      <div class="card">
        <div class="acet-top-bar">
          <div><label for="recFilterMonth">M√™s (YYYY-MM)</label><input type="month" id="recFilterMonth"></div>
        </div>
        <div class="acet-actions-top">
          <button class="btn-small" style="background:#007aff;color:#fff;" onclick="recSetCurrentMonth()">Hoje</button>
          <button class="btn-small btn-outline" onclick="recDownloadBackup()">Backup (.json)</button>
          <button class="btn-small btn-outline" onclick="recImportData()">Importar (colar JSON)</button>
        </div>
        <textarea id="recJsonArea" style="width:100%;height:120px;display:none;margin-top:8px;" placeholder="Cole aqui o JSON do backup e clique em Importar"></textarea>
      </div>

      <div class="card">
        <h2>Novo lan√ßamento em dinheiro</h2>
        <label for="recDateInput">Data</label><input type="date" id="recDateInput">
        <label for="recDescInput">Descri√ß√£o</label><input type="text" id="recDescInput" placeholder="Ex.: extras, servi√ßos avulsos...">
        <label for="recTypeInput">Tipo</label>
        <select id="recTypeInput">
          <option value="CREDITO">Cr√©dito (entra)</option>
          <option value="DEBITO">D√©bito (sai)</option>
        </select>
        <label for="recValueInput">Valor (R$)</label><input type="number" id="recValueInput" step="0.01" inputmode="decimal" placeholder="0,00">
        <label style="margin-top:8px;"><input type="checkbox" id="recRecurringInput" style="width:auto;margin-right:6px;">Recorrente (repete todo m√™s)</label>
        <button onclick="recAddTransaction()">Incluir lan√ßamento</button>
      </div>

      <div class="card">
        <h2>Lan√ßamentos do m√™s</h2>
        <div class="acet-scroll-table">
          <table style="width:100%;border-collapse:collapse;font-size:13px;">
            <thead style="background:#f2f2f7;">
              <tr><th style="text-align:left;padding:6px;">Data</th><th style="text-align:left;padding:6px;">Descri√ß√£o</th><th style="text-align:left;padding:6px;">Tipo</th><th style="text-align:right;padding:6px;">Cr√©dito</th><th style="text-align:right;padding:6px;">D√©bito</th><th style="text-align:center;padding:6px;"></th></tr>
            </thead>
            <tbody id="recTableBody"></tbody>
          </table>
        </div>
        <div class="acet-totais" id="recTotaisBox"></div>
      </div>

      <div class="card">
        <h2>Resumo do m√™s</h2>
        <div id="recResumoMes" class="acet-resumo-box"></div>
      </div>
    </div>
  </div>

  <div id="tab-dr" class="tab-content">
    <div class="card">
      <h2>DRE ‚Äì Consolida√ß√£o</h2>
      <div class="acet-sub">Leitura do Excel respeita (par√™nteses) como NEGATIVO.</div>

      <div class="card">
        <div class="acet-top-bar">
          <div><label for="drFilterMonth">M√™s (YYYY-MM)</label><input type="month" id="drFilterMonth"></div>
        </div>

        <label for="drXlsInput">Arquivo do DRE (XLS/XLSX)</label>
        <input type="file" id="drXlsInput" accept=".xls,.xlsx" />
        <button type="button" onclick="drLerDREExcel()">Ler DRE do Excel</button>
        <div id="drXlsStatus" class="acet-sub" style="margin-top:8px;"></div>
      </div>

      <div class="card">
        <h2>Campos do DRE</h2>
        <div class="summary-table-wrapper">
          <table class="summary-table">
            <thead><tr><th>Conta</th><th>Valor (R$)</th></tr></thead>
            <tbody>
              <tr><td>Lucro/Preju√≠zo do Exerc√≠cio</td><td><input id="dre_lucro_exercicio" type="number" step="0.01" inputmode="decimal" /></td></tr>
              <tr><td>Receitas n√£o operacionais (ajuste do sistema)</td><td><input id="dre_ajustes_sistema" type="number" step="0.01" inputmode="decimal" readonly /></td></tr>
              <tr><td><strong>Lucro/Preju√≠zo Ajustado</strong></td><td><input id="dre_lucro_ajustado" type="number" step="0.01" inputmode="decimal" readonly /></td></tr>
            </tbody>
          </table>
        </div>
        <small class="whatsapp-hint">O ajuste do sistema soma: (alugu√©is + energia extra, exceto Conveni√™ncia e Lava) + (dinheiro l√≠quido). Lava R√°pido √© acerto.</small>
      </div>

      <div class="card">
        <h2>Resumo para WhatsApp / Print</h2>
        <div id="drResumoTexto" class="acet-resumo-box"></div>
      </div>
    </div>
  </div>

<script>
/* TABS */
function showTab(tab){
  const tabs=["alugueis","acerto","receitas","dr"];
  tabs.forEach(t=>{
    document.getElementById("tab-"+t).classList.toggle("active", t===tab);
    document.getElementById("btnTab"+(t==="dr"?"DR":t.charAt(0).toUpperCase()+t.slice(1))).classList.toggle("active", t===tab);
  });
}

/* UNIDADES */
const tenantsDefault=["Pet Shop","Loja de Conveni√™ncia","Loja de Acess√≥rios","Cabeleireiro","Loja de Celulares","Lava R√°pido","Loja de Chocolate","Sanduicheria","Lavanderia"];
const UNIDADES_NAO_ENTRAM_NO_AJUSTE_DRE=new Set(["Loja de Conveni√™ncia","Lava R√°pido"]);
let currentMonth=null;
let tenantsData={};
function defaultTenantData(){return {rent:0,eStart:0,eEnd:0,discount:0,payments:[]};}
function loadConfig(){
  try{const cfg=JSON.parse(localStorage.getItem("alugueisConfig")||"{}"); if(cfg.valorKwh!=null) document.getElementById("valorKwh").value=cfg.valorKwh;}catch(e){}
}
function saveConfig(){
  const valorKwh=parseFloat(document.getElementById("valorKwh").value||"0")||0;
  localStorage.setItem("alugueisConfig",JSON.stringify({valorKwh}));
}
function loadMonthData(monthStr){
  const dataStr=localStorage.getItem("alugueisMes_"+monthStr);
  tenantsData={};
  if(dataStr){
    try{
      const parsed=JSON.parse(dataStr);
      tenantsDefault.forEach(n=>{
        tenantsData[n]=parsed[n]?parsed[n]:defaultTenantData();
        if(!Array.isArray(tenantsData[n].payments)) tenantsData[n].payments=[];
      });
    }catch(e){ tenantsDefault.forEach(n=>tenantsData[n]=defaultTenantData()); }
  }else tenantsDefault.forEach(n=>tenantsData[n]=defaultTenantData());
}
function saveMonthData(){ if(currentMonth) localStorage.setItem("alugueisMes_"+currentMonth, JSON.stringify(tenantsData)); }

/* ACERTO JULIANO */
const ACET_STORAGE_KEY="AcetJuli_v1";
function acetLoadData(){ try{const a=JSON.parse(localStorage.getItem(ACET_STORAGE_KEY)||"[]"); return Array.isArray(a)?a:[];}catch(e){return [];} }
function acetSaveData(d){ localStorage.setItem(ACET_STORAGE_KEY, JSON.stringify(d)); }
function acetFormatMoney(v){ return (v||0).toLocaleString("pt-BR",{minimumFractionDigits:2,maximumFractionDigits:2}); }
function acetSetCurrentMonth(){ const m=new Date().toISOString().slice(0,7); document.getElementById("acetFilterMonth").value=m; acetRender(); renderTenants(); }
function acetAddTransaction(){
  const date=document.getElementById("acetDateInput").value;
  const desc=document.getElementById("acetDescInput").value.trim();
  const type=document.getElementById("acetTypeInput").value;
  const value=parseFloat(String(document.getElementById("acetValueInput").value).replace(",","."));
  if(!date||!desc||isNaN(value)){alert("Preencha data, descri√ß√£o e valor.");return;}
  const data=acetLoadData();
  data.push({id:Date.now()+Math.floor(Math.random()*1000),date,description:desc,type,value});
  acetSaveData(data);
  if(!document.getElementById("acetFilterMonth").value) document.getElementById("acetFilterMonth").value=date.slice(0,7);
  document.getElementById("acetDescInput").value=""; document.getElementById("acetValueInput").value="";
  acetRender(); renderTenants();
}
function acetDeleteTransaction(id){ if(!confirm("Excluir?"))return; acetSaveData(acetLoadData().filter(t=>t.id!==id)); acetRender(); renderTenants(); }
function acetClearAll(){ if(!confirm("Apagar tudo?"))return; localStorage.removeItem(ACET_STORAGE_KEY); acetSaveData([]); acetRender(); renderTenants(); }
function acetDownloadBackup(){
  const blob=new Blob([JSON.stringify(acetLoadData(),null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob); const a=document.createElement("a");
  a.href=url; a.download="AcetJuli-backup-"+new Date().toISOString().replace(/[:.]/g,"-")+".json";
  document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
}
function acetImportData(){
  const area=document.getElementById("acetJsonArea"); area.style.display="block";
  if(!area.value.trim()){ alert("Cole o JSON no campo e clique de novo."); return; }
  try{ const arr=JSON.parse(area.value); if(!Array.isArray(arr)) throw new Error("JSON inv√°lido"); acetSaveData(arr); alert("Importado."); acetRender(); renderTenants(); }
  catch(e){ alert("Erro: "+e.message); }
}
function getLavaRapidoDebitoCreditoMes(monthStr){
  const data=acetLoadData(); let deb=0, cred=0;
  data.forEach(t=>{ if(t.date&&t.date.slice(0,7)===monthStr){ if(t.type==="DEBITO_RF") deb+=(t.value||0); else if(t.type==="CREDITO_JULIANO") cred+=(t.value||0);} });
  return {debitos:deb,creditos:cred};
}
function acetRender(){
  const m=document.getElementById("acetFilterMonth").value;
  const data=acetLoadData().filter(t=>!m || t.date.slice(0,7)===m).sort((a,b)=>a.date.localeCompare(b.date));
  const tbody=document.getElementById("acetTableBody"); tbody.innerHTML="";
  let deb=0, cred=0;
  data.forEach(t=>{
    if(t.type==="DEBITO_RF") deb+=t.value||0; else cred+=t.value||0;
    const tr=document.createElement("tr");
    tr.className=(t.type==="DEBITO_RF")?"acet-debit-row":"acet-credit-row";
    tr.innerHTML=`<td style="padding:6px;">${t.date}</td><td style="padding:6px;">${t.description}</td><td style="padding:6px;">${t.type==="DEBITO_RF"?"D√©bito (RF)":"Cr√©dito (Juliano)"}</td><td style="padding:6px;text-align:right;">R$ ${acetFormatMoney(t.value)}</td><td style="padding:6px;text-align:center;"><button class="btn-danger" onclick="acetDeleteTransaction(${t.id})">X</button></td>`;
    tbody.appendChild(tr);
  });
  if(!data.length){ const tr=document.createElement("tr"); tr.innerHTML=`<td colspan="5" style="padding:10px;text-align:center;">Sem lan√ßamentos.</td>`; tbody.appendChild(tr); }
  const saldo=deb-cred;
  document.getElementById("acetTotaisBox").innerHTML = `
    <div><strong>Total D√©bitos:</strong> R$ ${acetFormatMoney(deb)}</div>
    <div><strong>Total Cr√©ditos:</strong> R$ ${acetFormatMoney(cred)}</div>
    <div class="${saldo>=0?"saldo-positivo":"saldo-negativo"}" style="margin-top:4px;"><strong>Saldo:</strong> R$ ${acetFormatMoney(Math.abs(saldo))} (${saldo>=0?"Juliano devendo":"RF devendo"})</div>
  `;
  let resumo=`ACERTO JULIANO √ó RF\nM√™s: ${m||"sem m√™s"}\n\nTotal D√©bitos (RF): R$ ${acetFormatMoney(deb)}\nTotal Cr√©ditos (Juliano): R$ ${acetFormatMoney(cred)}\nSaldo: R$ ${acetFormatMoney(Math.abs(saldo))} (${saldo>=0?"Juliano DEVENDO":"RF DEVENDO"})`;
  document.getElementById("acetWhatsResumo").textContent=resumo;
}

/* RECEITAS DINHEIRO */
const REC_STORAGE_KEY="ReceitasNaoOperacionais_v1";
function recLoadData(){ try{const a=JSON.parse(localStorage.getItem(REC_STORAGE_KEY)||"[]"); return Array.isArray(a)?a:[];}catch(e){return [];} }
function recSaveData(d){ localStorage.setItem(REC_STORAGE_KEY, JSON.stringify(d)); }
function recSetCurrentMonth(){ const m=new Date().toISOString().slice(0,7); document.getElementById("recFilterMonth").value=m; recRender(); renderTenants(); }
function recAddTransaction(){
  const date=document.getElementById("recDateInput").value;
  const desc=document.getElementById("recDescInput").value.trim();
  const type=document.getElementById("recTypeInput").value;
  const value=parseFloat(String(document.getElementById("recValueInput").value).replace(",","."));
  const recurring=!!document.getElementById("recRecurringInput").checked;
  if(!date||!desc||isNaN(value)){alert("Preencha data, descri√ß√£o e valor.");return;}
  const data=recLoadData();
  data.push({id:Date.now()+Math.floor(Math.random()*1000),date,description:desc,type,value,recurring});
  recSaveData(data);
  if(!document.getElementById("recFilterMonth").value) document.getElementById("recFilterMonth").value=date.slice(0,7);
  document.getElementById("recDescInput").value=""; document.getElementById("recValueInput").value=""; document.getElementById("recRecurringInput").checked=false;
  recRender(); renderTenants();
}
function recDeleteTransaction(id){ if(!confirm("Excluir?"))return; recSaveData(recLoadData().filter(t=>t.id!==id)); recRender(); renderTenants(); }
function recDownloadBackup(){
  const blob=new Blob([JSON.stringify(recLoadData(),null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob); const a=document.createElement("a");
  a.href=url; a.download="ReceitasNaoOperacionais-backup-"+new Date().toISOString().replace(/[:.]/g,"-")+".json";
  document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
}
function recImportData(){
  const area=document.getElementById("recJsonArea"); area.style.display="block";
  if(!area.value.trim()){ alert("Cole o JSON no campo e clique de novo."); return; }
  try{ const arr=JSON.parse(area.value); if(!Array.isArray(arr)) throw new Error("JSON inv√°lido"); recSaveData(arr); alert("Importado."); recRender(); renderTenants(); }
  catch(e){ alert("Erro: "+e.message); }
}
function getReceitasLiquidasMes(monthStr){
  const data=recLoadData(); let cred=0, deb=0;
  data.forEach(t=>{ if(t.date&&t.date.slice(0,7)===monthStr){ if(t.type==="CREDITO") cred+=t.value||0; else deb+=t.value||0; }});
  return {liquido:cred-deb, totalCreditos:cred, totalDebitos:deb};
}
function recRender(){
  const m=document.getElementById("recFilterMonth").value;
  const data=recLoadData().filter(t=>!m || t.date.slice(0,7)===m).sort((a,b)=>a.date.localeCompare(b.date));
  const tbody=document.getElementById("recTableBody"); tbody.innerHTML="";
  let cred=0, deb=0;
  data.forEach(t=>{
    if(t.type==="CREDITO") cred+=t.value||0; else deb+=t.value||0;
    const tr=document.createElement("tr");
    tr.style.background = t.type==="CREDITO" ? "#e9ffea" : "#ffecec";
    tr.innerHTML=`<td style="padding:6px;">${t.date}</td><td style="padding:6px;">${t.description}${t.recurring?" üîÅ":""}</td><td style="padding:6px;">${t.type}</td>
                  <td style="padding:6px;text-align:right;">${t.type==="CREDITO"?"R$ "+acetFormatMoney(t.value):""}</td>
                  <td style="padding:6px;text-align:right;">${t.type==="DEBITO"?"R$ "+acetFormatMoney(t.value):""}</td>
                  <td style="padding:6px;text-align:center;"><button class="btn-danger" onclick="recDeleteTransaction(${t.id})">X</button></td>`;
    tbody.appendChild(tr);
  });
  if(!data.length){ const tr=document.createElement("tr"); tr.innerHTML=`<td colspan="6" style="padding:10px;text-align:center;">Sem lan√ßamentos.</td>`; tbody.appendChild(tr); }
  const liq=cred-deb;
  document.getElementById("recTotaisBox").innerHTML = `<div><strong>Total Cr√©ditos:</strong> R$ ${acetFormatMoney(cred)}</div><div><strong>Total D√©bitos:</strong> R$ ${acetFormatMoney(deb)}</div><div><strong>L√≠quido:</strong> R$ ${acetFormatMoney(liq)} (${liq>=0?"entra":"reduz"})</div>`;
  document.getElementById("recResumoMes").textContent = `RECEITAS EM DINHEIRO\nM√™s: ${m||"sem m√™s"}\n\nTotal Cr√©ditos: R$ ${acetFormatMoney(cred)}\nTotal D√©bitos: R$ ${acetFormatMoney(deb)}\nL√≠quido (ajuste DRE): R$ ${acetFormatMoney(liq)}`;
}

/* C√ÅLCULOS */
function calcTenantReceita(tData, valorKwh){
  const consumo=Math.max((tData.eEnd||0)-(tData.eStart||0),0);
  const energiaBruta=consumo*valorKwh;
  const descontoValor=energiaBruta*((tData.discount||0)/100);
  const energiaLiquida=energiaBruta-descontoValor;
  const totalMes=(tData.rent||0)+energiaLiquida;
  let pagos=0; (tData.payments||[]).forEach(p=>pagos+=(p.value||0));
  const saldo=totalMes-pagos;
  let status="ABERTO";
  if(Math.abs(saldo)<0.01 && totalMes>0) status="PAGO"; else if(pagos>0 && saldo>0.01) status="PARCIAL";
  return {consumo,energiaBruta,descontoValor,energiaLiquida,totalMes,pagos,saldo,status};
}
function formatMoney(v){ return "R$ "+(v||0).toFixed(2).replace(".",","); }
function statusClass(s){ return s==="PAGO"?"status-pago":(s==="PARCIAL"?"status-parcial":"status-aberto"); }

function renderTenants(){
  const container=document.getElementById("cardsContainer");
  container.innerHTML="";
  const valorKwh=parseFloat(document.getElementById("valorKwh").value||"0")||0;

  let sumAlug=0, sumEner=0;
  const quickRows=[];
  const lava = currentMonth ? getLavaRapidoDebitoCreditoMes(currentMonth) : {debitos:0,creditos:0};

  tenantsDefault.forEach((nome,i)=>{
    tenantsData[nome]=tenantsData[nome]||defaultTenantData();
    const tData=tenantsData[nome];
    const isLava = nome==="Lava R√°pido";
    const naoEntra = UNIDADES_NAO_ENTRAM_NO_AJUSTE_DRE.has(nome);

    let calc;
    if(!isLava){
      calc=calcTenantReceita(tData, valorKwh);
      if(!naoEntra){ sumAlug+=(tData.rent||0); sumEner+=calc.energiaLiquida; }
      quickRows.push({nome,aluguel:(tData.rent||0),energia:calc.energiaLiquida,total:calc.totalMes,pago:calc.pagos,saldo:calc.saldo,status:calc.status});
    }else{
      const consumo=Math.max((tData.eEnd||0)-(tData.eStart||0),0);
      const energiaBruta=consumo*valorKwh;
      const descontoValor=energiaBruta*((tData.discount||0)/100);
      const energiaLiquida=energiaBruta-descontoValor;
      const totalCobrar=(lava.debitos||0)+energiaLiquida;
      const pagos=(lava.creditos||0);
      const saldo=totalCobrar-pagos;
      let status="ABERTO"; if(Math.abs(saldo)<0.01 && totalCobrar>0) status="PAGO"; else if(pagos>0 && saldo>0.01) status="PARCIAL";
      calc={consumo,energiaBruta,descontoValor,energiaLiquida,totalMes:totalCobrar,pagos,saldo,status};
      quickRows.push({nome,aluguel:0,energia:energiaLiquida,total:totalCobrar,pago:pagos,saldo,status:"ACERTO-"+status});
    }

    const badge = naoEntra ? "n√£o entra no ajuste do DRE" : "entra no ajuste do DRE";
    const card=document.createElement("div");
    card.className="card";
    card.innerHTML=`
      <div class="card-header">
        <div class="card-title">${nome} <span class="acet-pill" style="margin-left:6px;">${badge}</span></div>
        <div class="status-tag ${statusClass(calc.status)}">${isLava?"ACERTO":" "+calc.status}</div>
      </div>
      <div class="grid-2">
        <div>
          <label>Aluguel (R$)</label>
          <input type="number" step="0.01" id="t${i}_rent" ${isLava?"readonly":""} value="${isLava?0:(tData.rent||"")}" onblur="updateTenant(${i})"/>
        </div>
        <div>
          <label>Desconto energia (%)</label>
          <input type="number" step="0.01" id="t${i}_discount" value="${tData.discount||""}" onblur="updateTenant(${i})"/>
        </div>
      </div>
      <div class="grid-3">
        <div><label>Leitura inicial (kWh)</label><input type="number" step="0.01" id="t${i}_eStart" value="${tData.eStart||""}" onblur="updateTenant(${i})"/></div>
        <div><label>Leitura final (kWh)</label><input type="number" step="0.01" id="t${i}_eEnd" value="${tData.eEnd||""}" onblur="updateTenant(${i})"/></div>
        <div><span class="small-label">Consumo</span><br/><span class="small-value">${calc.consumo.toFixed(2)}</span></div>
      </div>
      <div class="grid-3" style="margin-top:8px;">
        <div><span class="small-label">Energia bruta</span><br/><span class="small-value">${formatMoney(calc.energiaBruta)}</span></div>
        <div><span class="small-label">Desconto</span><br/><span class="small-value">${formatMoney(calc.descontoValor)}</span></div>
        <div><span class="small-label">Energia l√≠quida</span><br/><span class="small-value">${formatMoney(calc.energiaLiquida)}</span></div>
      </div>
      <div class="grid-2" style="margin-top:8px;">
        <div><span class="small-label">${isLava?"Total a cobrar no acerto":"Total do m√™s"}</span><br/><span class="small-value">${formatMoney(calc.totalMes)}</span></div>
        <div><span class="small-label">${isLava?"Pago pelo Juliano (m√™s)":"Total pago"}</span><br/><span class="small-value">${formatMoney(calc.pagos)}</span></div>
      </div>
      <div style="margin-top:4px;"><span class="small-label">${isLava?"Saldo do acerto":"Saldo a receber"}</span><br/><span class="small-value">${formatMoney(calc.saldo)}</span></div>
      ${isLava?`<div style="margin-top:8px;border-top:1px solid #e5e5ea;padding-top:6px;">
        <span class="small-label">Detalhe do acerto (m√™s ${currentMonth||""})</span><br/>
        <span class="small-value">D√©bitos RF: ${formatMoney(lava.debitos||0)}</span><br/>
        <span class="small-value">Cr√©ditos Juliano: ${formatMoney(lava.creditos||0)}</span>
      </div>`:""}
      <div class="payments">
        <strong>${isLava?"Pagamentos ficam na aba Acerto":"Pagamentos diretos"}</strong>
        <div class="payments-list" id="plist_${i}"></div>
        ${isLava?"":`
        <div class="grid-3" style="margin-top:6px;">
          <div><label>Valor pago</label><input type="number" step="0.01" id="t${i}_payValue"/></div>
          <div><label>Data</label><input type="date" id="t${i}_payDate"/></div>
          <div><label>Obs.</label><input type="text" id="t${i}_payNote" placeholder="PIX, dinheiro..."/></div>
        </div>
        <button onclick="addPayment(${i})">Adicionar pagamento</button>`}
      </div>
    `;
    container.appendChild(card);

    const plist=document.getElementById("plist_"+i);
    const pays=tData.payments||[];
    if(isLava) plist.innerHTML=`<div class="payment-note">Lava R√°pido √© acerto.</div>`;
    else if(!pays.length) plist.innerHTML=`<div class="payment-note">Nenhum pagamento lan√ßado.</div>`;
    else plist.innerHTML=pays.map((p,idx)=>`
      <div class="payment-row">
        <div><div><strong>${formatMoney(p.value||0)}</strong></div><div class="payment-note">${p.date||""} ‚Äì ${p.note||""}</div></div>
        <div><button class="secondary" style="padding:2px 6px;font-size:11px;" onclick="removePayment(${i},${idx})">x</button></div>
      </div>`).join("");
  });

  const receitas = currentMonth ? getReceitasLiquidasMes(currentMonth).liquido : 0;
  const totalMes = sumAlug + sumEner;
  const totalGeral = totalMes + (receitas||0);

  document.getElementById("summaryBox").style.display="block";
  document.getElementById("sumAlugueis").textContent=formatMoney(sumAlug);
  document.getElementById("sumEnergia").textContent=formatMoney(sumEner);
  document.getElementById("sumTotalMes").textContent=formatMoney(totalMes);
  document.getElementById("sumReceitasExtra").textContent=formatMoney(receitas||0);
  document.getElementById("sumTotalGeral").textContent=formatMoney(totalGeral);

  document.getElementById("summaryUnidadesBox").style.display="block";
  document.getElementById("summaryUnidadesBody").innerHTML = quickRows.map(r=>`
    <tr><td>${r.nome}</td><td>${formatMoney(r.aluguel)}</td><td>${formatMoney(r.energia)}</td><td>${formatMoney(r.total)}</td><td>${formatMoney(r.pago)}</td><td>${formatMoney(r.saldo)}</td><td>${r.status}</td></tr>
  `).join("");

  drAtualizarResumo();
}

function updateTenant(index){
  const nome=tenantsDefault[index];
  const tData=tenantsData[nome]||defaultTenantData();
  if(nome!=="Lava R√°pido") tData.rent=parseFloat(document.getElementById("t"+index+"_rent").value||"0")||0;
  else tData.rent=0;
  tData.discount=parseFloat(document.getElementById("t"+index+"_discount").value||"0")||0;
  tData.eStart=parseFloat(document.getElementById("t"+index+"_eStart").value||"0")||0;
  tData.eEnd=parseFloat(document.getElementById("t"+index+"_eEnd").value||"0")||0;
  tenantsData[nome]=tData;
  saveConfig(); saveMonthData(); renderTenants();
}
function addPayment(index){
  const nome=tenantsDefault[index];
  if(nome==="Lava R√°pido"){alert("Lava √© acerto.");return;}
  const val=parseFloat(String(document.getElementById("t"+index+"_payValue").value||"0").replace(",","."));
  if(!(val>0)){alert("Valor inv√°lido.");return;}
  const date=document.getElementById("t"+index+"_payDate").value||"";
  const note=document.getElementById("t"+index+"_payNote").value||"";
  const tData=tenantsData[nome]||defaultTenantData();
  tData.payments=tData.payments||[];
  tData.payments.push({value:val,date,note});
  tenantsData[nome]=tData;
  saveMonthData(); renderTenants();
}
function removePayment(index,idx){
  const nome=tenantsDefault[index];
  const tData=tenantsData[nome]||defaultTenantData();
  (tData.payments||[]).splice(idx,1);
  tenantsData[nome]=tData;
  saveMonthData(); renderTenants();
}

function initMonth(){
  const m=document.getElementById("mesRef").value;
  if(!m){alert("Selecione o m√™s.");return;}
  currentMonth=m;
  loadMonthData(currentMonth);
  saveConfig();
  renderTenants();
  document.getElementById("acetFilterMonth").value=currentMonth; acetRender();
  document.getElementById("recFilterMonth").value=currentMonth; recRender();
  document.getElementById("drFilterMonth").value=currentMonth; drAtualizarResumo();
}

function getResumoAjusteAlugueisEnergiaMes(monthStr){
  let valorKwh=0;
  try{const cfg=JSON.parse(localStorage.getItem("alugueisConfig")||"{}"); valorKwh=parseFloat(cfg.valorKwh||"0")||0;}catch(e){}
  let map={}; try{map=JSON.parse(localStorage.getItem("alugueisMes_"+monthStr)||"{}");}catch(e){map={};}
  let sum=0;
  tenantsDefault.forEach(nome=>{
    if(UNIDADES_NAO_ENTRAM_NO_AJUSTE_DRE.has(nome)) return;
    const t=map[nome]||defaultTenantData();
    const consumo=Math.max((t.eEnd||0)-(t.eStart||0),0);
    const energiaBruta=consumo*valorKwh;
    const energiaLiquida=energiaBruta - energiaBruta*((t.discount||0)/100);
    sum += (t.rent||0) + energiaLiquida;
  });
  return sum;
}

/* DRE */
function drVal(id){ const el=document.getElementById(id); const v=parseFloat(String(el.value||"").replace(",","."));
  return isNaN(v)?0:v;
}
function drAtualizarResumo(){
  const mes=document.getElementById("drFilterMonth").value||"";
  const lucro=drVal("dre_lucro_exercicio");
  let ajustes=0;
  if(mes){
    ajustes = getResumoAjusteAlugueisEnergiaMes(mes) + (getReceitasLiquidasMes(mes).liquido||0);
  }
  document.getElementById("dre_ajustes_sistema").value=ajustes.toFixed(2);
  const ajustado=lucro+ajustes;
  document.getElementById("dre_lucro_ajustado").value=ajustado.toFixed(2);
  const fmt=v=>"R$ "+(v||0).toFixed(2).replace(".",",");
  document.getElementById("drResumoTexto").textContent =
    `DRE CONSOLIDADO ‚Äì ${mes||"sem m√™s"}\n\n`+
    `Lucro/Preju√≠zo do Exerc√≠cio (DRE): ${fmt(lucro)}\n`+
    `Ajuste do sistema (alugu√©is/energia extra + dinheiro): ${fmt(ajustes)}\n`+
    `Lucro/Preju√≠zo Ajustado: ${fmt(ajustado)}\n`;
}

/* LEITURA EXCEL: negativos (par√™nteses) */
function __dreParseMoney(v){
  if(v===null||v===undefined) return null;
  if(typeof v==="number") return isNaN(v)?null:v;
  let s=String(v).trim();
  if(!s) return null;
  let negative=false;
  if(s.includes("(") && s.includes(")")){ negative=true; s=s.replace(/[()]/g,""); }
  if(s.endsWith("-")){ negative=true; s=s.slice(0,-1); }
  s=s.replace(/R\$\s*/gi,"").replace(/\s+/g,"");
  if(s.includes(",") && s.includes(".")) s=s.replace(/\./g,"").replace(",",".");
  else if(s.includes(",") && !s.includes(".")) s=s.replace(",",".");
  s=s.replace(/[^0-9.\-]/g,"");
  if(s.startsWith("-")) negative=true;
  const n=parseFloat(s);
  if(isNaN(n)) return null;
  return negative ? -Math.abs(n) : n;
}

async function drLerDREExcel(){
  const st=document.getElementById("drXlsStatus");
  const inp=document.getElementById("drXlsInput");
  if(!inp.files || !inp.files[0]){ alert("Selecione o arquivo."); return; }
  if(!window.XLSX){ alert("Biblioteca XLSX n√£o carregou."); return; }
  st.textContent="Lendo...";
  try{
    const buf=await inp.files[0].arrayBuffer();
    const wb=XLSX.read(buf,{type:"array"});
    const ws=wb.Sheets[wb.SheetNames[0]];
    const rows=XLSX.utils.sheet_to_json(ws,{header:1,raw:false,defval:""});
    let found=null;

    // acha linha com "Lucro/Preju√≠zo do Exerc√≠cio" e pega o primeiro valor num√©rico depois
    for(const r of rows){
      const label=String(r[0]||"").toLowerCase();
      if(label.includes("lucro") && label.includes("exerc")){
        for(let i=1;i<r.length;i++){
          const p=__dreParseMoney(r[i]);
          if(p!==null){ found=p; break; }
        }
      }
      if(found!==null) break;
    }
    if(found===null){
      st.textContent="N√£o encontrei a linha do Lucro/Preju√≠zo do Exerc√≠cio.";
      return;
    }
    document.getElementById("dre_lucro_exercicio").value=Number(found).toFixed(2);
    st.textContent="OK. Valor lido: "+found;
    drAtualizarResumo();
  }catch(e){
    st.textContent="Erro: "+e.message;
  }
}

/* INIT */
window.addEventListener("load", ()=>{
  loadConfig();
  const mesAtual=new Date().toISOString().slice(0,7);
  document.getElementById("mesRef").value=mesAtual;
  currentMonth=mesAtual;
  loadMonthData(currentMonth);
  renderTenants();

  const dateStr=new Date().toISOString().slice(0,10);
  document.getElementById("acetDateInput").value=dateStr;
  document.getElementById("recDateInput").value=dateStr;

  document.getElementById("btnCarregarMes").addEventListener("click", initMonth);
  document.getElementById("valorKwh").addEventListener("change", ()=>{ saveConfig(); renderTenants(); });

  document.getElementById("acetFilterMonth").value=mesAtual;
  document.getElementById("acetFilterMonth").addEventListener("change", ()=>{ acetRender(); renderTenants(); });
  acetRender();

  document.getElementById("recFilterMonth").value=mesAtual;
  document.getElementById("recFilterMonth").addEventListener("change", ()=>{ recRender(); renderTenants(); });
  recRender();

  document.getElementById("drFilterMonth").value=mesAtual;
  document.getElementById("drFilterMonth").addEventListener("change", ()=>drAtualizarResumo());
  drAtualizarResumo();
});
</script>
</body>
</html>
